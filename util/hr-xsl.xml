<?xml version="1.0" encoding="UTF-8"?>

<!--
This Ant build script defines several helper tasks for using HR-XSL. To use, simply import it, then call the pre-defined macros. See the HR-XSL examples for some examples.
Author: Trevor Harmon
-->

<project name="hr-xsl" default="all">

	<!-- Handle to the environment properties -->
	<property environment="env"/>

	<!-- Directory of this build file (instead of the directory of whatever includes this file)-->
	<dirname property="hr-xsl.basedir" file="${ant.file.hr-xsl}/.."/>

	<!-- Location of the DocBook XSL stylesheets -->
	<property name="docbook.xsl.dir" value="${hr-xsl.basedir}/lib/docbook-xsl-1.72.0"/> 

	<!-- Location of the DocBook DTD -->
	<property name="docbook.xml.dir" value="${hr-xsl.basedir}/lib/docbook-xml-4.5"/> 

	<path id="saxon.classpath">   
		<fileset dir="${hr-xsl.basedir}/lib/saxon-b-8.9">   
			<include name="**/*.jar"/>   
		</fileset>   
	</path>   

	<!-- Load the FOP task -->
    <taskdef name="fop" classname="org.apache.fop.tools.anttasks.Fop">
		<classpath>
			<fileset dir="${hr-xsl.basedir}/lib/fop-0.93">
				<include name="fop.jar"/>
				<include name="lib/*.jar"/> 
			</fileset>
		</classpath>
	</taskdef>
	
	<!-- Load the JTidy task -->
	<taskdef name="tidy" classname="org.w3c.tidy.ant.JTidyTask">
		<classpath>
			<pathelement location="${hr-xsl.basedir}/lib/jtidy-r8-SNAPSHOT/jtidy-r8-SNAPSHOT.jar"/>
		</classpath>
	</taskdef>

	<!-- Load the Ant-Contrib tasks -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${hr-xsl.basedir}/lib/ant-contrib-1.0b3/ant-contrib.jar"/>
		</classpath>
	</taskdef>

	<!-- Tidy up an HTML file -->
	<macrodef name="tidy-html">
		<attribute name="in" description="The HTML file to tidy up"/>
		<sequential>
			<tempfile property="temp.file"/> 
			<tidy srcfile="@{in}" destfile="${temp.file}" failonerror="true"> 
				<parameter name="indent" value="auto"/>  
				<parameter name="wrap" value="0"/>   <!-- Turn off line wrapping -->
			</tidy> 
			<move file="${temp.file}" tofile="@{in}"/>  
		</sequential>
	</macrodef>
	
	<!-- Performs an XSL translation of an XML file using the Saxon processor. -->
	<presetdef name="saxon">
		<!-- The processor=SaxonLiaison setting causes our custom XSLTLiaison class to be used. -->
		<!-- This works around bug #41314: http://issues.apache.org/bugzilla/show_bug.cgi?id=41314 -->
		<xslt classpath="${hr-xsl.basedir}/lib/saxon-b-8.8/saxon8.jar:${hr-xsl.basedir}/util" processor="SaxonLiaison">
			<xmlcatalog>
				<entity publicId="parameters" location="${basedir}/parameters.xsl"/>
			</xmlcatalog>
		</xslt>
	</presetdef>

	<!-- Converts an HR-XML resume file into DocBook format -->
	<macrodef name="resume-to-docbook">
		<attribute name="in" description="The filename of the HR-XML resume"/>
		<sequential>
			<dirname property="in.dir" file="@{in}"/>
			<basename property="in.filename" file="@{in}" suffix=".xml"/> 
			<property name="in" value="${in.dir}/${in.filename}"/>
			<saxon in="@{in}" out="${in}-docbook.xml" style="${hr-xsl.basedir}/util/customization-layer.xsl">
				<xmlcatalog>
					<entity publicId="stylesheet" location="${hr-xsl.basedir}/xsl/docbook/hr-xsl.xsl"/>
				</xmlcatalog>
			</saxon>
		</sequential>
	</macrodef>

	<!-- Converts a DocBook file into a specified format -->
	<macrodef name="docbook-to"> 
		<attribute name="in" description="The DocBook file"/>
		<attribute name="out" description="The output file"/>
		<attribute name="format" description="The format of the output ('fo' or 'html')"/>
		<sequential> 
			<saxon in="@{in}" out="@{out}" style="${hr-xsl.basedir}/util/customization-layer.xsl">
				<xmlcatalog> 
					<entity publicId="stylesheet" location="${docbook.xsl.dir}/@{format}/docbook.xsl"/> 
				</xmlcatalog> 
			</saxon>
		</sequential> 
	</macrodef>

	<!-- Converts an HR-XML resume to HTML -->
	<macrodef name="resume-to-html"> 
		<attribute name="in" description="The filename of the HR-XML resume"/> 
		<sequential>
			
			<!-- Determine the filenames -->
			<dirname property="in.dir" file="@{in}"/> 
			<basename property="in.filename" file="@{in}" suffix=".xml"/>  
			<property name="in" value="${in.dir}/${in.filename}"/>
			
			<!-- Convert the HR-XML to DocBook -->
			<outofdate>
				<sourcefiles>
					<pathelement path="@{in}"/>
				</sourcefiles>
				<targetfiles>
					<pathelement path="${in}-docbook.xml"/>
				</targetfiles>
				<sequential>
					<resume-to-docbook in="@{in}"/> 
					<!-- Do not tidy the XML output. Both jTidy and xmllint are unable to preserve spaces properly when tidying. -->
					<!-- <tidy-xml in="${in}-docbook.xml"/> -->
				</sequential>
			</outofdate>

			<!-- Convert the DocBook to HTML -->
			<outofdate>
				<sourcefiles>
					<pathelement path="${in}-docbook.xml"/>
				</sourcefiles>
				<targetfiles>
					<pathelement path="${in}.html"/>
				</targetfiles>
				<sequential>
					<docbook-to format="html" in="${in}-docbook.xml" out="${in}.html"/> 
					<tidy-html in="${in}.html"/>
				</sequential>
			</outofdate>
			
		</sequential> 
	</macrodef> 
	
	<!-- Converts an HR-XML resume to PDF -->
	<macrodef name="resume-to-pdf"> 
		<attribute name="in" description="The filename of the HR-XML resume"/> 
		<sequential> 

			<!-- Determine the filenames -->
			<dirname property="in.dir" file="@{in}"/> 
			<basename property="in.filename" file="@{in}" suffix=".xml"/>  
			<property name="in" value="${in.dir}/${in.filename}"/>

			<!-- Convert the HR-XML to DocBook -->
			<outofdate>
				<sourcefiles>
					<pathelement path="@{in}"/>
				</sourcefiles>
				<targetfiles>
					<pathelement path="${in}-docbook.xml"/>
				</targetfiles>
				<sequential>
					<resume-to-docbook in="@{in}"/> 
					<!-- Do not tidy the XML output. Both jTidy and xmllint are unable to preserve spaces properly when tidying. -->
					<!-- <tidy-xml in="${in}-docbook.xml"/> -->
				</sequential>
			</outofdate>

			<!-- Convert the DocBook to FO -->
			<outofdate> 
				<sourcefiles> 
					<pathelement path="${in}-docbook.xml"/> 
				</sourcefiles> 
				<targetfiles> 
					<pathelement path="${in}.fo"/> 
				</targetfiles> 
				<sequential> 
					<docbook-to format="fo" in="${in}-docbook.xml" out="${in}.fo"/>  
					<!-- Do not tidy the XML output. Both jTidy and xmllint are unable to preserve spaces properly when tidying. -->
					<!-- <tidy-xml in="${in}.fo"/>  -->
				</sequential> 
			</outofdate> 

			<!-- Convert the FO to PDF -->
			<outofdate> 
				<sourcefiles> 
					<pathelement path="${in}.fo"/> 
				</sourcefiles> 
				<targetfiles> 
					<pathelement path="${in}.pdf"/> 
				</targetfiles> 
				<sequential> 
					<fop fofile="${in}.fo" outfile="${in}.pdf" format="application/pdf"/> 
				</sequential> 
			</outofdate> 

		</sequential> 
	</macrodef> 
	
	<!-- Converts an HR-XML resume to plain text -->
	<macrodef name="resume-to-text"> 
		<attribute name="in" description="The filename of the HR-XML resume"/> 
		<sequential>

			<!-- Determine the filenames -->
			<dirname property="in.dir" file="@{in}"/> 
			<basename property="in.filename" file="@{in}" suffix=".xml"/>  
			<property name="in" value="${in.dir}/${in.filename}"/>

			<!-- Convert the HR-XML to HTML -->
			<resume-to-html in="@{in}"/>

			<!-- Convert the HTML to plain text -->
			<outofdate>
				<sourcefiles>
					<pathelement path="${in}.html"/>
				</sourcefiles>
				<targetfiles>
					<pathelement path="${in}.txt"/>
				</targetfiles>
				<sequential>
					
					<!-- Make sure the lynx command is available -->
					<available file="lynx" filepath="${env.PATH}" property="lynx-available"/>
					<fail unless="lynx-available" message="Could not create plain-text version of resume because lynx was not found on the path (${env.PATH}). Please install Lynx (http://lynx.isc.org/)."/>
					
					<!-- Use lynx to convert the HTML to plain text -->
					<exec executable="lynx" output="${in}.txt">
						<arg line="-dump -nolist '${in}.html'"/>
					</exec>

				</sequential>
			</outofdate>

		</sequential> 
	</macrodef> 
	
</project>
